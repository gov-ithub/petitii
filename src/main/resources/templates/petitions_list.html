<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/main_head :: head"></head>

<body class="nav-md">
<div class="container body">
    <div class="main_container">
        <div class="col-md-3 left_col" th:substituteby="fragments/left::menu"></div>

        <!-- top navigation -->
        <div class="top_nav" th:substituteby="fragments/top::menu"></div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
            <div id="error-messages"></div>
            <div class="">
                <h2>Petițiile mele</h2>
                <div class="col-md-6 col-sm-6 col-xs-12">
                    <div class="radio">
                     <label>
                       <input type="radio" class="flat" name="iCheck" id="started"/> Petiții în lucru
                     </label>
                   </div>
                   <div class="radio">
                     <label>
                       <input type="radio" class="flat" name="iCheck" id="all" checked="true"/> Toate
                     </label>
                   </div>
                </div>
                <div class="col-md-6 col-sm-6 col-xs-12">
                	  <div class="buttons pull-right">
                          <button id="add" type="button" class="btn btn-default btn-md"><i class="fa fa-plus-square-o"></i>&nbsp;<span>Adaugă</span></button>
                          <button id="modify" type="button" class="btn btn-default btn-md"><i class="fa fa-pencil-square-o"></i>&nbsp;<span>Modifică</span></button>
                          <button id="start" type="button" class="btn btn-default btn-md"><i class="fa fa-hourglass-start"></i>&nbsp;<span>Incepe lucrul</span></button>
                          <button id="classify" type="button" class="btn btn-default btn-md"><i class="fa fa-share-square-o"></i>&nbsp;<span>Clasează</span></button>
                          <button id="resolve" type="button" class="btn btn-default btn-md"><i class="fa fa-check-square-o"></i>&nbsp;<span>Rezolvă</span></button>
                          <button id="redirect" type="button" class="btn btn-default btn-md"><i class="fa fa-mail-forward"></i>&nbsp;<span>Redirecționează</span></button>
                	  </div>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <table id="datatable-responsive" class="table table-striped table-bordered dt-responsive nowrap jambo_table bulk_action" cellspacing="0" width="100%">
                </table>
            </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer>
            <div class="pull-right">
                Gentelella - Bootstrap Admin Template by <a href="https://colorlib.com">Colorlib</a>
            </div>
            <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
    </div>
</div>

<div th:replace="fragments/main_head::includes"></div>

<!-- Variables from backend -->
<script th:inline="javascript">
    /*<![CDATA[*/
    var apiUrl = /*[[${apiUrl}]]*/ '/api/emails';
    var languageUrl = /*[[@{/vendors/datatables.net-i18n/Romanian.json}]]*/ "../static/vendors/datatables.net-i18n/Romanian.json";
    /*]]>*/
</script>

<script type="text/javascript">
    /*<![CDATA[*/
    function strLimit(data, limit) {
        if ((data!=null) && (data.length > limit)){
            data = data.substr(0, limit);
            data += '...';
        }
        return data;
    }

    var emailTable;
    $(document).ready(function () {
        var statusFilter = "all";

        <!-- Datatables -->
        var petitionTable = $('#datatable-responsive').DataTable({
            select: {
                style: 'multi'
            },
            processing: true,
            serverSide: true,
            sDom: 'lrtip ',
            order: [[1, 'desc']],
            rowId: "id",
            ajax: {
                url: apiUrl,
                type: 'POST',
                data: function(d) {
                    d["status"] = statusFilter;
                }
            },
            language: {
                url: languageUrl,
                select: selectTranslation()
            },
            columns: [
                {
                    data: null,
                    render: function (data, type, full, meta) {
                        return '<input type="checkbox"/>';
                    },
                    sortable: false,
                    className: 'text-center',
                    width: '15px'
                },
                {
                    name: 'regNo',
                    data: 'regNo',
                    title: 'Numar inregistrare'
                },
                {
                    name: 'petitioner.lastName',
                    data: 'petitionerName',
                    title: 'Nume petent',
                    render: function (data) {
                        return strLimit(data, 30);
                    }
                },
                {
                    name: 'petitionerEmail',
                    data: 'petitionerEmail',
                    title: 'Email petent'
                },
                {
                    name: '_abstract',
                    data: '_abstract',
                    title: 'Rezumat petitie',
                    render: function (data) {
                        return strLimit(data, 70);
                    },
                    sortable: false
                },
                {
                    name: 'status',
                    data: 'status',
                    title: 'Status'
                }
            ]
        });

        selectActions(petitionTable);

        $("#add").click(function () {
            window.location.href = '/petition';
        });

        $("#modify").click(function () {
            var selectedRows = petitionTable.rows({selected: true}).data().toArray();
            if (selectedRows.length != 1) {
                addWarning("#error-messages", "Pentru modificări selectați o singură petiție");
                this.blur()
            } else {
                window.location.href = '/petition/' + selectedRows[0].id;
            }
        });

        $("#start").click(function () {
            var selectedRows = [];
            $.each(petitionTable.rows({selected: true}).data().toArray(),function (i, row) {
                selectedRows.push(row.id);
            });
            console.log(selectedRows);
            if (selectedRows.length < 1) {
                addWarning("#error-messages", "Pentru a schimba statusul, selectati macar o petitie");
                this.blur()
            } else {
                $.ajax({
                    url: "/api/petitions/start-work",
                    data: {'petitions':selectedRows},
                    method: 'post'
                }).success(function(data){
                    if (data.success=="true") {
                        addSuccess("#error-messages", data.errorMsg);
                        petitionTable.ajax.reload();
                    } else {
                        addError("#error-messages", data.errorMsg);
                        petitionTable.ajax.reload();
                    }
                }).fail(function(){

                });
            }
        });

        $('input[name=iCheck]').on('ifChecked', function (event) {
            statusFilter = event.target.id;
            petitionTable.ajax.reload();
        });
    });
    /*]]>*/
</script>

<div th:substituteby="fragments/main_head::toast"></div>
</body>
</html>